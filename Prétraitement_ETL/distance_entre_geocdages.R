

# données deja geocodées# verif des distances entre les deux geocodages 

library(sf)

# rapport/prepa_publi.Rmd

adresse <- sf::st_read("data/verif/distance.geojson")
adresse_filtre <- sf::st_drop_geometry(adresse) 
adresse_filtre$distance <-as.numeric(adresse_filtre$distance)

# sum(adresse_filtre$distance > 5)

geocoder_main <- sf::st_read("data/geocodage_main_total.geojson")
#st_write(geocoder_main, "data/verif/deja_geocoder.geojson")

# on va chercher l'adresse 
geocodage_clb.shp <- sf::st_read("data/sortie_15_04.shp" , stringsAsFactors = FALSE)

adresse_complement <- geocodage_clb.shp %>% 
    dplyr::select(ID_CARTO, Commune, CP, nb_rue_p, rue_p, compl_add_, pt_remarq_, lieudit_p ) %>% 
    tidyr::unite("Adresse", nb_rue_p, rue_p, sep = " ",  na.rm = TRUE) %>% 
    tidyr::unite("Info_sup", lieudit_p, compl_add_, pt_remarq_, na.rm = TRUE)


adresse_complement_distance <- dplyr::inner_join(adresse_complement, adresse_filtre, by = "ID_CARTO")

adresse_complement_distance <- adresse_complement_distance[adresse_complement_distance$distance >= 5,]
adresse_complement_distance$geocodage_main <- NA

# finalement on vire les  deja geocodés

adresse_complement_distance <- adresse_complement_distance[!adresse_complement_distance$ID_CARTO %in% geocoder_main$adresse_id,]

adresse_matthieu <- adresse_complement_distance[1:(length(adresse_complement_distance$ID_CARTO)/2),]
#st_write(adresse_matthieu, "data/verif/adresse_matthieu.geojson" )

adresse_olivier <- adresse_complement_distance[(length(adresse_complement_distance$ID_CARTO)/2):length(adresse_complement_distance$ID_CARTO),]
#st_write(adresse_olivier, "data/verif/adresse_olivier.geojson")


#### le reste 

adresse_filtre$preci_clb <-  substr(adresse_filtre$preci_clb , 1, 1)
# table(substr(adresse_filtre$preci_clb , 1, 1))

table(adresse_filtre$preci_evs, useNA = "ifany")

adresse_filtre$preci_evs[adresse_filtre$preci_evs =="housenumber"] <- "1"
adresse_filtre$preci_evs[adresse_filtre$preci_evs =="street"] <- "3"
adresse_filtre$preci_evs[adresse_filtre$preci_evs =="locality"] <- "4"
adresse_filtre$preci_evs[adresse_filtre$preci_evs =="municipality"] <- "6"

adresse_filtre_proche <- adresse_filtre[adresse_filtre$distance <= 5 , ]

table(adresse_filtre_proche$preci_clb, adresse_filtre_proche$preci_evs)


##### rural / urbain 

communes.shp <- sf::st_read("data/commune.shp")

adresse$distance <- as.numeric(adresse$distance)

adresse_commune.shp <- st_join(
                        adresse, 
                        st_transform(communes.shp[,c("TYPE_CO", "insee")], 2154))

adresse_commune_proche.shp <- adresse_commune.shp[adresse_commune.shp$distance <= 5,]

table(adresse_commune_proche.shp$TYPE_CO)